<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç»˜å›¾</title>
    <style>
        /* ... ä¿ç•™ä¹‹å‰çš„ CSS ... */
        :root {
            --primary-color: #f6821f;
            --bg-color: #f9f9f9;
            --card-bg: #ffffff;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: var(--bg-color); color: #333; }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;}
        
        /* æ–°å¢ï¼šé€‰æ‹©æ¡†æ ·å¼ */
        select {
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            outline: none;
            background: white;
            min-width: 120px;
            cursor: pointer;
        }
        select:focus { border-color: var(--primary-color); }

        input { flex: 1; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 8px; outline: none; min-width: 200px;}
        button { padding: 12px 24px; font-size: 16px; cursor: pointer; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; white-space: nowrap;}
        
        /* ... ä¿ç•™ä¹‹å‰çš„ CSS (main-display, history ç­‰) ... */
        .status-bar { text-align: center; margin-bottom: 20px; color: #666; font-size: 14px;}
        #main-display { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; min-height: 300px; }
        #main-display img { max-width: 100%; border-radius: 8px; margin-top: 15px;}
        .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;}
        .history-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer;}
    </style>
</head>
<body>

    <h1 style="text-align: center;">ğŸ¨ AI åˆ›æ„ç”»å»Š (çœæµæ¨¡å¼)</h1>

    <div class="input-group">
        <!-- æ–°å¢ï¼šå°ºå¯¸é€‰æ‹©å™¨ -->
        <select id="size-select">
            <option value="512x512">æ–¹å½¢ 1:1 (512px)</option>
            <option value="640x360">å®½å± 16:9 (640px)</option>
            <option value="360x640">æ‰‹æœº 9:16 (360px)</option>
            <option value="512x384">æ¨ªå‘ 4:3 (512px)</option>
            <option value="1024x1024">é«˜æ¸… 1:1 (æ…ç”¨)</option>
        </select>

        <input type="text" id="prompt" placeholder="æè¿°ä½ çš„åˆ›æ„..." />
        <button onclick="handleGenerate()" id="btn">ç”Ÿæˆ</button>
    </div>

    <div class="status-bar" id="status">é»˜è®¤ä½¿ç”¨ 512px åˆ†è¾¨ç‡ä»¥èŠ‚çœæ¶ˆè€—</div>

    <div id="main-display">
        <p style="color: #ccc;">ç”Ÿæˆçš„å›¾ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
    </div>

    <!-- å†å²è®°å½•åŒºåŸŸ (ä»£ç å¤ç”¨ä¹‹å‰çš„ï¼Œæ­¤å¤„çœç•¥éƒ¨åˆ†ç»†èŠ‚) -->
    <div style="margin-top: 40px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
        <h3>ğŸ“œ å†å²è®°å½• <button onclick="clearHistory()" style="font-size: 12px; padding: 5px 10px; background: transparent; color: #666; border: 1px solid #ddd;">æ¸…ç©º</button></h3>
    </div>
    <div id="history-gallery" class="history-grid"></div>

    <script>
        const MAX_HISTORY = 12;
        let historyData = JSON.parse(localStorage.getItem('ai_images_history')) || [];

        const ui = {
            input: document.getElementById('prompt'),
            select: document.getElementById('size-select'), // è·å–ä¸‹æ‹‰æ¡†
            btn: document.getElementById('btn'),
            status: document.getElementById('status'),
            main: document.getElementById('main-display'),
            gallery: document.getElementById('history-gallery')
        };

        renderHistory();

        async function handleGenerate() {
            const prompt = ui.input.value.trim();
            if (!prompt) return alert("è¯·è¾“å…¥æç¤ºè¯");

            // è·å–é€‰ä¸­çš„å°ºå¯¸
            const sizeStr = ui.select.value; // ä¾‹å¦‚ "512x512"
            const [width, height] = sizeStr.split('x').map(Number);

            setLoading(true);
            
            try {
                // å‘é€ prompt ä»¥åŠ width, height ç»™åç«¯
                const req = await fetch('/api/draw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: prompt,
                        width: width,
                        height: height
                    })
                });

                ui.status.innerText = "ä¼˜åŒ–å®Œæˆï¼Œæ­£åœ¨ç»˜åˆ¶...";
                
                const data = await req.json();
                if (data.error) throw new Error(data.error);

                const newRecord = {
                    id: Date.now(),
                    userPrompt: prompt,
                    aiPrompt: data.translatedPrompt,
                    image: data.image,
                    time: new Date().toLocaleTimeString()
                };

                showMainImage(newRecord);
                saveToHistory(newRecord);
                
                ui.status.innerText = `âœ¨ ç”ŸæˆæˆåŠŸ (${width}x${height})ï¼`;

            } catch (err) {
                ui.status.innerText = "âŒ å‡ºé”™äº†";
                alert(err.message);
            } finally {
                setLoading(false);
            }
        }

        // ... showMainImage, saveToHistory, renderHistory, clearHistory ç­‰å‡½æ•°ä¿æŒä¹‹å‰çš„é€»è¾‘ä¸å˜ ...
        // ä¸ºäº†ç¯‡å¹…ç®€æ´ï¼Œè¿™é‡Œä¸å†é‡å¤ç²˜è´´ï¼Œè¯·ä¿ç•™ä½ ä¸Šä¸€æ­¥å·²ç»å†™å¥½çš„è¿™äº›å‡½æ•°
        function showMainImage(record) {
             ui.main.innerHTML = `<img src="${record.image}" style="max-height:500px">`;
        }
        function saveToHistory(record) {
            historyData.unshift(record);
            if(historyData.length > MAX_HISTORY) historyData.pop();
            localStorage.setItem('ai_images_history', JSON.stringify(historyData));
            renderHistory();
        }
        function renderHistory() {
            ui.gallery.innerHTML = '';
            historyData.forEach(item => {
                const img = document.createElement('img');
                img.src = item.image;
                img.onclick = () => showMainImage(item);
                const div = document.createElement('div');
                div.className = 'history-card';
                div.appendChild(img);
                ui.gallery.appendChild(div);
            });
        }
        function clearHistory() {
            localStorage.removeItem('ai_images_history');
            historyData = [];
            renderHistory();
        }
        function setLoading(isLoading) {
            ui.btn.disabled = isLoading;
            ui.btn.innerText = isLoading ? "ç”Ÿæˆä¸­..." : "ç”Ÿæˆ";
        }
    </script>
</body>
</html>
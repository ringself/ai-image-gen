<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç»˜å›¾ (å¸¦å†å²è®°å½•)</title>
    <style>
        :root {
            --primary-color: #f6821f;
            --bg-color: #f9f9f9;
            --card-bg: #ffffff;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: var(--bg-color); color: #333; }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 8px; outline: none; transition: border 0.3s;}
        input:focus { border-color: var(--primary-color); }
        button { padding: 12px 24px; font-size: 16px; cursor: pointer; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; transition: opacity 0.3s; white-space: nowrap;}
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { opacity: 0.9; }

        /* çŠ¶æ€æ¡ */
        .status-bar { text-align: center; margin-bottom: 20px; min-height: 24px; font-size: 14px; color: #666; }
        
        /* ä¸»å±•ç¤ºåŒº (æœ€æ–°ç”Ÿæˆ) */
        #main-display { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; min-height: 300px; display: flex; flex-direction: column; align-items: center; justify-content: center;}
        #main-display img { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 15px;}
        .prompt-box { background: #f0f4f8; padding: 10px 15px; border-radius: 6px; font-size: 13px; color: #555; width: 100%; box-sizing: border-box; text-align: left; border-left: 4px solid var(--primary-color);}
        
        /* å†å²è®°å½•åŒº */
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-top: 40px; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px;}
        .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        
        /* å†å²è®°å½•å¡ç‰‡ */
        .history-card { background: var(--card-bg); border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #eee;}
        .history-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .history-card img { width: 100%; height: 150px; object-fit: cover; display: block;}
        .history-info { padding: 8px; font-size: 12px; color: #777; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        
        .clear-btn { background: transparent; color: #999; border: 1px solid #ddd; padding: 5px 10px; font-size: 12px; }
        .clear-btn:hover { color: red; border-color: red; background: #fff0f0;}

        /* åŠ¨ç”» */
        @keyframes fadein { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadein 0.5s; }
    </style>
</head>
<body>

    <h1 style="text-align: center;">ğŸ¨ AI åˆ›æ„ç”»å»Š</h1>

    <div class="input-group">
        <input type="text" id="prompt" placeholder="æè¿°ä½ çš„åˆ›æ„ (æ”¯æŒä¸­æ–‡)ï¼Œä¾‹å¦‚ï¼šèµ›åšæœ‹å…‹é£æ ¼çš„å¤ä»£å°†å†›" />
        <button onclick="handleGenerate()" id="btn">å¼€å§‹ç”Ÿæˆ</button>
    </div>

    <div class="status-bar" id="status"></div>

    <!-- ä¸»å±•ç¤ºåŒºï¼šæ˜¾ç¤ºåˆšåˆšç”Ÿæˆçš„ï¼Œæˆ–è€…ä»å†å²è®°å½•ç‚¹å‡»çš„ -->
    <div id="main-display">
        <p style="color: #ccc;">ç”Ÿæˆçš„å›¾ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
    </div>

    <!-- å†å²è®°å½•åŒºåŸŸ -->
    <div class="history-header">
        <h3>ğŸ“œ å†å²è®°å½•</h3>
        <button class="clear-btn" onclick="clearHistory()">æ¸…ç©ºå†å²</button>
    </div>
    <div id="history-gallery" class="history-grid">
        <!-- å†å²å›¾ç‰‡å°†æ³¨å…¥åˆ°è¿™é‡Œ -->
    </div>

    <script>
        // 1. åˆå§‹åŒ–ï¼šä» LocalStorage è¯»å–å†å²è®°å½•
        // é™åˆ¶åªå­˜æœ€è¿‘ 12 å¼ ï¼Œé˜²æ­¢ LocalStorage çˆ†æ»¡ (Base64 å¾ˆå¤§)
        const MAX_HISTORY = 12;
        let historyData = JSON.parse(localStorage.getItem('ai_images_history')) || [];

        const ui = {
            input: document.getElementById('prompt'),
            btn: document.getElementById('btn'),
            status: document.getElementById('status'),
            main: document.getElementById('main-display'),
            gallery: document.getElementById('history-gallery')
        };

        // é¡µé¢åŠ è½½æ—¶æ¸²æŸ“å†å²
        renderHistory();

        // 2. ä¸»ç”Ÿæˆé€»è¾‘
        async function handleGenerate() {
            const prompt = ui.input.value.trim();
            if (!prompt) return alert("è¯·è¾“å…¥æç¤ºè¯");

            setLoading(true);
            
            try {
                // ç¬¬ä¸€æ­¥ï¼šè°ƒç”¨åç«¯
                const req = await fetch('/api/draw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                ui.status.innerText = "ä¼˜åŒ–å®Œæˆï¼Œæ­£åœ¨ç»˜åˆ¶...";
                
                const data = await req.json();
                if (data.error) throw new Error(data.error);

                // ç¬¬äºŒæ­¥ï¼šæ„å»ºæ–°çš„è®°å½•å¯¹è±¡
                const newRecord = {
                    id: Date.now(), // å”¯ä¸€ID
                    userPrompt: prompt,
                    aiPrompt: data.translatedPrompt,
                    image: data.image,
                    time: new Date().toLocaleTimeString()
                };

                // ç¬¬ä¸‰æ­¥ï¼šå±•ç¤ºå¹¶ä¿å­˜
                showMainImage(newRecord);
                saveToHistory(newRecord);
                
                ui.status.innerText = "âœ¨ ç”ŸæˆæˆåŠŸï¼";
                ui.input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†

            } catch (err) {
                ui.status.innerText = "âŒ å‡ºé”™äº†";
                alert("ç”Ÿæˆå¤±è´¥: " + err.message);
            } finally {
                setLoading(false);
            }
        }

        // 3. åœ¨ä¸»åŒºåŸŸæ˜¾ç¤ºå¤§å›¾
        function showMainImage(record) {
            ui.main.innerHTML = `
                <div class="fade-in" style="width: 100%">
                    <div class="prompt-box">
                        <strong>è¾“å…¥:</strong> ${record.userPrompt}<br/>
                        <span style="color:#888; font-size:12px;">AIä¼˜åŒ–: ${record.aiPrompt}</span>
                    </div>
                    <img src="${record.image}" alt="Generated Image">
                    <div style="margin-top:10px; font-size:12px; color:#999;">ç”Ÿæˆæ—¶é—´: ${record.time}</div>
                </div>
            `;
        }

        // 4. ä¿å­˜åˆ°å†å²è®°å½• (LocalStorage)
        function saveToHistory(record) {
            // æŠŠæ–°è®°å½•åŠ åˆ°æ•°ç»„æœ€å‰é¢
            historyData.unshift(record);
            
            // é™åˆ¶æ•°é‡ï¼Œé˜²æ­¢å­˜å‚¨ç©ºé—´æº¢å‡º
            if (historyData.length > MAX_HISTORY) {
                historyData.pop(); // åˆ é™¤æœ€æ—§çš„
            }

            // å­˜å…¥æµè§ˆå™¨
            try {
                localStorage.setItem('ai_images_history', JSON.stringify(historyData));
            } catch (e) {
                console.error("å­˜å‚¨ç©ºé—´å·²æ»¡", e);
                // å¦‚æœæ»¡äº†ï¼Œå°è¯•åˆ é™¤æœ€åä¸€å¼ å†å­˜
                historyData.pop();
                localStorage.setItem('ai_images_history', JSON.stringify(historyData));
            }

            renderHistory();
        }

        // 5. æ¸²æŸ“å†å²åˆ—è¡¨
        function renderHistory() {
            ui.gallery.innerHTML = '';
            
            historyData.forEach(item => {
                const card = document.createElement('div');
                card.className = 'history-card fade-in';
                card.onclick = () => showMainImage(item); // ç‚¹å‡»é‡æ–°æŸ¥çœ‹å¤§å›¾

                card.innerHTML = `
                    <img src="${item.image}" loading="lazy" alt="thumb">
                    <div class="history-info">
                        <strong>${item.userPrompt}</strong>
                    </div>
                `;
                ui.gallery.appendChild(card);
            });
        }

        // 6. æ¸…ç©ºå†å²
        function clearHistory() {
            if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                historyData = [];
                localStorage.removeItem('ai_images_history');
                renderHistory();
                ui.main.innerHTML = '<p style="color: #ccc;">å†å²å·²æ¸…ç©º</p>';
            }
        }

        // å·¥å…·ï¼šLoading çŠ¶æ€åˆ‡æ¢
        function setLoading(isLoading) {
            ui.btn.disabled = isLoading;
            ui.btn.innerText = isLoading ? "ç”Ÿæˆä¸­..." : "å¼€å§‹ç”Ÿæˆ";
            if (isLoading) ui.status.innerText = "æ­£åœ¨æ€è€ƒä¼˜åŒ–æç¤ºè¯...";
        }
    </script>
</body>
</html>